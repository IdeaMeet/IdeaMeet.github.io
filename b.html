<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>跳转管理后台1941</title>
</head>
<body>
  <h1>跳转管理后台</h1>

  <div>
    <label>
      管理员 Token：
      <input id="token" type="password" style="width:300px;">
    </label>
  </div>

  <div style="margin-top:10px;">
    <label>
      目标 URL：
      <input id="url" type="text" style="width:450px;">
    </label>
  </div>

  <div style="margin-top:10px;">
    <label>
      兜底 URL：
      <input id="fallback" type="text" style="width:450px;">
    </label>
  </div>

  <div style="margin-top:10px;">
    <label>
      最大访问量（0=无限）：
      <input id="maxCount" type="number" style="width:120px;">
    </label>
  </div>

  <button id="save" style="margin-top:10px;">保存配置</button>

  <p id="status"></p>

  <script>
    const API_BASE = "https://urljump-three.vercel.app";

    const tokenInput = document.getElementById("token");
    const urlInput = document.getElementById("url");
    const fallbackInput = document.getElementById("fallback");
    const maxCountInput = document.getElementById("maxCount");
    const statusEl = document.getElementById("status");

    // ① 自动从 localStorage 读取 token
    tokenInput.value = localStorage.getItem("adminToken") || "";

    async function loadConfig() {
      const resp = await fetch("./config.json?_t=" + Date.now());
      const cfg = await resp.json();
      urlInput.value = cfg.url || "";
      fallbackInput.value = cfg.fallbackUrl || "";
      maxCountInput.value = cfg.maxCount || 0;
    }

    async function saveConfig() {
      const token = tokenInput.value.trim();
      const url = urlInput.value.trim();
      const fallback = fallbackInput.value.trim();
      const maxCount = Number(maxCountInput.value);

      if (!token) return alert("请输入 Token");

      // ② 把 token 缓存到 localStorage
      localStorage.setItem("adminToken", token);

      const resp = await fetch(`${API_BASE}/api/update-config`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          url,
          fallbackUrl: fallback,
          maxCount
        })
      });

      const data = await resp.json();
      statusEl.innerText = JSON.stringify(data);
    }

    document.getElementById("save").onclick = saveConfig;

    loadConfig();
  </script>
</body>
</html>
